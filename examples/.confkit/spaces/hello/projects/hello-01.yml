project:
  name: "hello-app"
  type: "hello"
  description: "hello world 部署示例"

source:
  git_repo: "https://github.com/confkit/engine.git"
  git_branch: "main"

environment:
  NODE_ENV: "production"
  NPM_CONFIG_REGISTRY: "https://registry.npmmirror.com"

steps:
  - name: "1. 代码拉取"
    working_dir: "./volumes/workspace"
    commands:
      - "git clone ${GIT_REPO} ${PROJECT_NAME}-${TASK_ID}"
      - "chmod -R 777 ${PROJECT_NAME}-${TASK_ID}"
    timeout: "3m"

  - name: "2.安装依赖"
    container: "hello-builder"
    working_dir: "/workspace/${PROJECT_NAME}-${TASK_ID}"
    commands:
      - "echo 'hello world'"

  - name: "3.代码检查"
    container: "hello-builder"
    working_dir: "/workspace/${PROJECT_NAME}-${TASK_ID}"
    commands:
      - "echo 'check hello world'"
    continue_on_error: true

  - name: "4.运行测试"
    container: "hello-builder"
    working_dir: "/workspace/${PROJECT_NAME}-${TASK_ID}"
    commands:
      - "echo 'test hello world'"
    parallel_group: "quality"

  - name: "5.构建应用"
    container: "hello-builder"
    working_dir: "/workspace/${PROJECT_NAME}-${TASK_ID}"
    commands:
      - "echo 'build hello world'"
      - "mkdir /artifacts/${PROJECT_NAME}-${TASK_ID}"
      - "echo \"{\\\"project\\\":\\\"${PROJECT_NAME}\\\",\\\"version\\\":\\\"${GIT_BRANCH:-main}\\\",\\\"git_hash\\\":\\\"${GIT_HASH}\\\",\\\"build_time\\\":\\\"$(date -Iseconds)\\\",\\\"task_id\\\":\\\"${TASK_ID}\\\"}\" > /artifacts/${PROJECT_NAME}-${TASK_ID}/build-info.json"

  - name: "6.收集产物"
    container: "hello-builder"
    commands:
      - "echo '生成构建信息: /artifacts/${PROJECT_NAME}-${TASK_ID}/build-info.json'"

  - name: "7.清理临时文件"
    container: "hello-builder"
    commands:
      - "rm -rf /workspace/${PROJECT_NAME}-${TASK_ID}"
      # - "rm -rf /artifacts/${PROJECT_NAME}-${TASK_ID}"

step_options:
  retry: 2
  timeout: "15m" 