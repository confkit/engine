name: "confkit-engine"
description: "ConfKit å¼•æ“"

source:
  git_repo: "https://github.com/confkit/engine.git"
  git_branch: "main"

environment:
  # è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆåŸºäºå†…ç½®å˜é‡ï¼‰
  BUILD_TARGET_DIR: "target"
  ARTIFACTS_DIR: "/artifacts"
steps:
  # 1. ç¯å¢ƒå‡†å¤‡å’Œä»£ç æ£€æŸ¥
- name: "å‡†å¤‡å‘å¸ƒç¯å¢ƒ"
  container: "rust-builder-1.88"
  working_dir: "/workspace"
  commands:
  - "echo 'ğŸš€ å¼€å§‹ ConfKit v$RELEASE_VERSION å‘å¸ƒæµç¨‹'"
  - "echo 'Git Hash: ${GIT_HASH}'"
  - "echo 'Build Date: $BUILD_DATE'"
  - "echo 'Task ID: ${TASK_ID}'"
  - "echo 'Project: ${PROJECT_NAME}'"
  - "rustc --version"
  - "cargo --version"
  timeout: "2m"

  # - name: "ä»£ç è´¨é‡æ£€æŸ¥"
  #   container: "rust-builder:1.88"
  #   working_dir: "/workspace"
  #   commands:
  #     - "echo 'ğŸ” æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥'"
  #     - "cargo fmt --check"
  #     - "cargo clippy --all-targets --all-features -- -D warnings"
  #   timeout: "5m"

  # - name: "è¿è¡Œæµ‹è¯•å¥—ä»¶"
  #   container: "rust-builder:1.88"
  #   working_dir: "/workspace"
  #   commands:
  #     - "echo 'ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶'"
  #     - "cargo test --all-features"
  #     - "cargo test --release"
  #   timeout: "10m"

- name: "å…‹éš†é¡¹ç›®"
  working_dir: "/volumes/workspace"
  commands:
  - "echo 'ğŸ” å…‹éš†é¡¹ç›®'"
  - "git clone ${GIT_REPO} -b main ${PROJECT_NAME}-${GIT_HASH}"

- name: "å®‰è£…ä¾èµ–"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'ğŸ” å®‰è£…ä¾èµ–'"
  - "cargo install --path ."

  # 2. å¤šå¹³å°æ„å»º
- name: "æ„å»º Linux x86_64"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'ğŸ—ï¸ æ„å»º Linux x86_64'"
  - "cargo build --release --target x86_64-unknown-linux-gnu"
      # - "strip target/x86_64-unknown-linux-gnu/release/confkit"
  timeout: "15m"

- name: "æ„å»º Linux ARM64"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'ğŸ—ï¸ æ„å»º Linux ARM64'"
  - "cargo build --release --target aarch64-unknown-linux-gnu"
  timeout: "20m"

- name: "æ„å»º macOS Intel"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'ğŸ æ„å»º macOS Intel'"
  - "cargo build --release --target x86_64-apple-darwin"
  timeout: "15m"

- name: "æ„å»º macOS Apple Silicon"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'ğŸ æ„å»º macOS Apple Silicon'"
  - "cargo build --release --target aarch64-apple-darwin"
  timeout: "15m"

  # 3. æ„å»ºéªŒè¯
- name: "éªŒè¯æ„å»ºäº§ç‰©"
  container: "rust-builder:1.88"
  working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  commands:
  - "echo 'âœ… éªŒè¯æ„å»ºäº§ç‰©'"
  - "ls -la target/*/release/confkit"
  - "target/x86_64-unknown-linux-gnu/release/confkit --version"
  - "target/aarch64-unknown-linux-gnu/release/confkit --version"
  - "target/x86_64-apple-darwin/release/confkit --version"
  - "target/aarch64-apple-darwin/release/confkit --version"
  - "echo 'æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ'"
  timeout: "3m"

  # - name: "æ‰“ tag"
  #   working_dir: "/workspace/${PROJECT_NAME}-${GIT_HASH}"
  #   commands:
  #     - "echo 'ğŸ” æ‰“ tag'"
  #     - "git tag v$RELEASE_VERSION"
  #     - "git push origin v$RELEASE_VERSION"
  #   timeout: "1m"

  # 5. å‘å¸ƒåˆ°å„ç§æ¸ é“
  # - name: "å‘å¸ƒåˆ° GitHub Releases"
  #   working_dir: "volumes/workspace/${PROJECT_NAME}-${GIT_HASH}"
  #   commands:
  #     - "echo 'ğŸ“¦ å‘å¸ƒåˆ° GitHub Releases'"
  #     - "gh release create v$RELEASE_VERSION --title 'ConfKit v$RELEASE_VERSION' --notes-file CHANGELOG.md"
  #     - "gh release upload v$RELEASE_VERSION target/x86_64-unknown-linux-gnu/release/confkit"
  #     - "gh release upload v$RELEASE_VERSION target/aarch64-unknown-linux-gnu/release/confkit"
  #     - "gh release upload v$RELEASE_VERSION target/x86_64-apple-darwin/release/confkit"
  #     - "gh release upload v$RELEASE_VERSION target/aarch64-apple-darwin/release/confkit"
  #     - "echo 'âœ… GitHub Release åˆ›å»ºå®Œæˆ'"
  #   timeout: "5m"

  # # 6. å‘å¸ƒåéªŒè¯
  # - name: "éªŒè¯å‘å¸ƒç»“æœ"
  #   container: "release-tools"
  #   working_dir: "/workspace"
  #   # commands:
  #   #   - "echo 'ğŸ” éªŒè¯å‘å¸ƒç»“æœ'"
  #   #   - "gh release view v$RELEASE_VERSION"
  #   #   - "echo 'âœ… æ‰€æœ‰å‘å¸ƒæ¸ é“éªŒè¯å®Œæˆ'"
  #   # timeout: "5m"
